{% extends "base.html" %}
{% block title %}Assign Task{% endblock %}
{% block content %}
<h1>Assign Task: {{ task.title }}</h1>

<div class="task-meta">
    <p><strong>Due Date:</strong> {{ task.due_date }}</p>
    <p><strong>Description:</strong> {{ task.description or 'No description' }}</p>
    <p><strong>Already Assigned:</strong> {{ assigned_count }} students</p>
    <p><strong>Total Students:</strong> {{ total_students }} students</p>
</div>

<div class="form-card">
    <h3>Student Assignment Status</h3>

    {% if all_students %}
    <div class="alert alert-info" style="margin-bottom: 20px;">
        <strong>Instructions:</strong>
        <ul style="margin-top: 8px; margin-left: 20px;">
            <li>Check boxes for students you want to <strong>assign</strong> (currently unassigned)</li>
            <li>Uncheck boxes for students you want to <strong>unassign</strong> (currently assigned)</li>
            <li>Click "Update Assignments" to save changes</li>
        </ul>
    </div>

    <form method="POST" action="{{ url_for('update_task_assignments', task_id=task.id) }}" id="assignForm">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Select to Assign/Unassign</th>
                        <th>USN</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Department</th>
                        <th>Current Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in all_students %}
                    <tr>
                        <td style="text-align: center; vertical-align: middle;">
                            <input type="checkbox" name="student_ids" value="{{ student.id }}" class="student-checkbox"
                                {% if student.assigned %}checked{% endif %}>
                        </td>
                        <td>{{ student.usn }}</td>
                        <td>{{ student.name }}</td>
                        <td>{{ student.class }}</td>
                        <td>{{ student.department }}</td>
                        <td>
                            {% if student.assigned %}
                            <span class="badge badge-present">Assigned</span>
                            {% else %}
                            <span class="badge badge-absent">Not Assigned</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="form-group" style="margin: 15px 0;">
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="select-all" style="width: 18px; height: 18px; margin-right: 8px;">
                Select/Deselect All Students
            </label>
            <small style="display: block; color: #666; margin-top: 5px;">
                Checking = Assign (if currently unassigned) | Unchecking = Unassign (if currently assigned)
            </small>
        </div>

        <div class="form-actions" style="display: flex; gap: 10px; align-items: center;">
            <button type="submit" class="btn btn-primary" id="submitBtn">Update Assignments</button>
            <a href="{{ url_for('tasks') }}" class="btn btn-secondary">Back to Tasks</a>
            <a href="{{ url_for('task_detail', task_id=task.id) }}" class="btn btn-info">View Progress</a>
        </div>
    </form>
    {% else %}
    <div class="alert alert-info">
        <p>No students found in the system.</p>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const selectAllCheckbox = document.getElementById('select-all');
        const studentCheckboxes = document.querySelectorAll('.student-checkbox');
        const submitBtn = document.getElementById('submitBtn');

        // Select All functionality
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function (e) {
                studentCheckboxes.forEach(function (checkbox) {
                    checkbox.checked = e.target.checked;
                });
            });
        }

        // Update Select All checkbox when individual checkboxes change
        studentCheckboxes.forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                if (selectAllCheckbox) {
                    const allChecked = Array.from(studentCheckboxes).every(cb => cb.checked);
                    const anyChecked = Array.from(studentCheckboxes).some(cb => cb.checked);

                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = !allChecked && anyChecked;
                }
            });
        });

        // Form submission validation
        if (submitBtn) {
            submitBtn.addEventListener('click', function (e) {
                const anyChecked = Array.from(studentCheckboxes).some(cb => cb.checked);
                if (!anyChecked) {
                    if (!confirm('No students selected. This will unassign all currently assigned students. Continue?')) {
                        e.preventDefault();
                    }
                }
            });
        }
    });
</script>

<style>
    .badge-present {
        background: #d1fae5;
        color: #065f46;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }

    .badge-absent {
        background: #fee2e2;
        color: #991b1b;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }

    .btn-info {
        background: #3b82f6;
        color: white;
    }

    .btn-info:hover {
        background: #2563eb;
    }

    .table td {
        vertical-align: middle;
    }

    .student-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .alert-info {
        background: #dbeafe;
        color: #1e40af;
        border-left: 4px solid #3b82f6;
        padding: 15px;
        border-radius: 8px;
    }

    .alert-info ul {
        margin-top: 5px;
    }
</style>
{% endblock %}