{% extends "base.html" %}
{% block title %}Students{% endblock %}
{% block content %}
<h1>Student Management</h1>

<!-- Add Student Form -->
<div class="form-card">
    <h3>Add New Student</h3>
    <form method="POST" action="{{ url_for('add_student') }}">
        <div class="form-group">
            <label for="usn">USN <span class="required">*</span></label>
            <input type="text" id="usn" name="usn" required>
        </div>
        <div class="form-group">
            <label for="name">Name <span class="required">*</span></label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
            <label for="email">Email <span class="required">*</span></label>
            <input type="email" id="email" name="email" required>
        </div>
        <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" name="phone">
        </div>
        <div class="form-row">
            <div class="form-group half">
                <label for="class">Class <span class="required">*</span></label>
                <input type="text" id="class" name="class" required placeholder="e.g., 10A">
            </div>
            <div class="form-group half">
                <label for="department">Department <span class="required">*</span></label>
                <input type="text" id="department" name="department" required placeholder="e.g., BCom">
            </div>
        </div>
        <h4>Parent/Guardian Details</h4>
        <div class="form-group">
            <label for="parent_name">Parent Name</label>
            <input type="text" id="parent_name" name="parent_name">
        </div>
        <div class="form-group">
            <label for="parent_phone">Parent Phone</label>
            <input type="tel" id="parent_phone" name="parent_phone">
        </div>
        <div class="form-group">
            <label for="parent_email">Parent Email</label>
            <input type="email" id="parent_email" name="parent_email">
        </div>
        <button type="submit" class="btn btn-primary">Add Student</button>
    </form>
</div>
<div class="form-actions" style="margin-bottom: 1rem;">
    <a href="{{ url_for('bulk_upload_students') }}" class="btn btn-primary">
        ðŸ“¤ Bulk Upload Students (CSV)
    </a>
</div>
<!-- Student List -->
<h2>All Students</h2>
<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>USN</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Class</th>
                <th>Department</th>
                <th>Parent Name</th>
                <th>Parent Phone</th>
                <th>Parent Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td>{{ student.usn }}</td>
                <td>{{ student.name }}</td>
                <td>{{ student.email }}</td>
                <td>{{ student.phone or '-' }}</td>
                <td>{{ student.class }}</td>
                <td>{{ student.department }}</td>
                <td>{{ student.parent_name or '-' }}</td>
                <td>{{ student.parent_phone or '-' }}</td>
                <td>{{ student.parent_email or '-' }}</td>
                <td>
                    <button class="btn btn-sm btn-edit"
                        onclick='openEditModal({{ student.id }}, {{ student.usn|tojson }}, {{ student.name|tojson }}, {{ student.email|tojson }}, {{ student.phone|tojson }}, {{ student.class|tojson }}, {{ student.department|tojson }}, {{ student.parent_name|tojson }}, {{ student.parent_phone|tojson }}, {{ student.parent_email|tojson }})'>
                        Edit
                    </button>
                    <form method="POST" action="{{ url_for('delete_student', id=student.id) }}" style="display:inline;"
                        onsubmit="return confirm('Delete this student? All related records will also be deleted.');">
                        <button type="submit" class="btn btn-sm btn-delete">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="10">No students added yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h3>Edit Student</h3>
        <form method="POST" action="" id="editForm">
            <div class="form-group">
                <label for="edit_usn">USN <span class="required">*</span></label>
                <input type="text" id="edit_usn" name="usn" required>
            </div>
            <div class="form-group">
                <label for="edit_name">Name <span class="required">*</span></label>
                <input type="text" id="edit_name" name="name" required>
            </div>
            <div class="form-group">
                <label for="edit_email">Email <span class="required">*</span></label>
                <input type="email" id="edit_email" name="email" required>
            </div>
            <div class="form-group">
                <label for="edit_phone">Phone</label>
                <input type="tel" id="edit_phone" name="phone">
            </div>
            <div class="form-row">
                <div class="form-group half">
                    <label for="edit_class">Class <span class="required">*</span></label>
                    <input type="text" id="edit_class" name="class" required>
                </div>
                <div class="form-group half">
                    <label for="edit_department">Department <span class="required">*</span></label>
                    <input type="text" id="edit_department" name="department" required>
                </div>
            </div>
            <h4>Parent/Guardian Details</h4>
            <div class="form-group">
                <label for="edit_parent_name">Parent Name</label>
                <input type="text" id="edit_parent_name" name="parent_name">
            </div>
            <div class="form-group">
                <label for="edit_parent_phone">Parent Phone</label>
                <input type="tel" id="edit_parent_phone" name="parent_phone">
            </div>
            <div class="form-group">
                <label for="edit_parent_email">Parent Email</label>
                <input type="email" id="edit_parent_email" name="parent_email">
            </div>
            <button type="submit" class="btn btn-primary">Update Student</button>
        </form>
        
    </div>
</div>

<script>
    function openEditModal(id, usn, name, email, phone, studentClass, department, parentName, parentPhone, parentEmail) {
        const modal = document.getElementById("editModal");
        const form = document.getElementById("editForm");
        form.action = `/students/edit/${id}`;
        document.getElementById("edit_usn").value = usn;
        document.getElementById("edit_name").value = name;
        document.getElementById("edit_email").value = email;
        document.getElementById("edit_phone").value = phone || '';
        document.getElementById("edit_class").value = studentClass;
        document.getElementById("edit_department").value = department;
        document.getElementById("edit_parent_name").value = parentName || '';
        document.getElementById("edit_parent_phone").value = parentPhone || '';
        document.getElementById("edit_parent_email").value = parentEmail || '';
        modal.style.display = "block";
    }

    function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
    }

    window.onclick = function (event) {
        const modal = document.getElementById("editModal");
        if (event.target === modal) {
            modal.style.display = "none";
        }
    };
</script>
{% endblock %}